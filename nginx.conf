events {}

http {
    server {
        listen 80;

        location / {
            proxy_pass http://your_upstream_server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_intercept_errors on;
            error_page 500 502 503 504 = @retry;
            add_header X-Proxy "NGINX";
                proxy_next_upstream_timeout 3;
            proxy_next_upstream_tries 3;

        location = @retry {
            proxy_pass http://your_upstream_server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header X-Proxy "NGINX";
            }
        }
    }
}

location / {
    # Proxy only 5xx errors to upstream server
    proxy_intercept_errors on;
    error_page 500 502 503 504 = @retry;

    # Send all other responses directly to the client
    proxy_pass http://your_upstream_server;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    add_header X-Proxy "NGINX";

    # Optional: Configure timeouts and retry attempts
    proxy_next_upstream_timeout 3;
    proxy_next_upstream_tries 3;
}

location = @retry {
    # Retry location for 5xx errors
    proxy_pass http://your_upstream_server;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    add_header X-Proxy "NGINX";
}

